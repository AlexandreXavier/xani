const G=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],y={temperature:{hex:14427686,css:"#DC2626"},temperatureMax:{hex:15680580,css:"#EF4444"},temperatureMin:{hex:6333946,css:"#60A5FA"},wind:{hex:7041664,css:"#6B7280"}},I=.15,z=3.2,W=.35,D=1,_=5,C=.1,S=1.5,H="porto_climate_";function $(){const x=[],e=new Date;for(let s=0;s<7;s++){const n=new Date(e);n.setDate(e.getDate()+s),s===0?x.push("Hoje"):x.push(G[n.getDay()])}return x}class q extends HTMLElement{city={latitude:41.1496,longitude:-8.611,name:"Porto"};scene=null;camera=null;renderer=null;orbitControls=null;animationId=null;resizeObserver=null;themeObserver=null;ringMeshes={temperature:null,wind:null};ringLabels={temperature:[],wind:[]};climateData=null;focusedRing=null;isDarkMode=!1;isDetailedMode=!1;isLoading=!0;DAYS=$();connectedCallback(){const e=this.dataset.city;if(e)try{this.city=JSON.parse(e)}catch{console.warn("Invalid city config, using default Porto")}this.isDarkMode=document.documentElement.dataset.theme==="dark",this.loadViewMode(),this.waitForThreeJS().then(()=>{this.initScene(),this.setupEventListeners(),this.setupThemeObserver(),this.loadData(),this.animate()})}disconnectedCallback(){this.animationId&&cancelAnimationFrame(this.animationId),this.resizeObserver&&this.resizeObserver.disconnect(),this.themeObserver&&this.themeObserver.disconnect(),this.renderer&&this.renderer.dispose(),this.orbitControls&&this.orbitControls.dispose()}async waitForThreeJS(){return new Promise(e=>{const s=()=>{typeof THREE<"u"&&THREE.OrbitControls?e():requestAnimationFrame(s)};s()})}setupThemeObserver(){this.themeObserver=new MutationObserver(e=>{for(const s of e)s.attributeName==="data-theme"&&(this.isDarkMode=document.documentElement.dataset.theme==="dark",this.updateSceneColors(),this.renderAllRings())}),this.themeObserver.observe(document.documentElement,{attributes:!0})}initScene(){const e=this.querySelector(".chart-wrapper");if(!e)return;const s=e.clientWidth,n=e.clientHeight;this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(33,s/n,.1,1e3),this.camera.position.set(9,9,9),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(s,n),this.renderer.setPixelRatio(window.devicePixelRatio),e.appendChild(this.renderer.domElement),this.orbitControls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.orbitControls.target.set(0,2,0),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.05,this.orbitControls.enablePan=!1,this.orbitControls.enableZoom=!1,this.orbitControls.minPolarAngle=Math.PI/2.5,this.orbitControls.maxPolarAngle=Math.PI/2.5,this.orbitControls.update();const a=new THREE.AmbientLight(16777215,.8);this.scene.add(a);const t=new THREE.DirectionalLight(16777215,.4);t.position.set(5,10,5),this.scene.add(t);const i=new THREE.DirectionalLight(16777215,.3);i.position.set(-5,8,-5),this.scene.add(i);const r=new THREE.DirectionalLight(16777215,.2);r.position.set(0,-5,0),this.scene.add(r),this.createBasePlatform(),this.createDayLabels(),this.createCenterLabel(),this.resizeObserver=new ResizeObserver(()=>this.handleResize()),this.resizeObserver.observe(e)}createBasePlatform(){if(!this.scene)return;const e=4;let s=[0,0,0,0,0,0,0],n=0;if(this.climateData?.precipitation){s=this.climateData.precipitation.map(u=>u??0);const o=s.filter(u=>u>0);n=o.length>0?Math.max(...o):0}const a=8246268;for(let o=0;o<7;o++){const u=o/7*Math.PI*2-Math.PI/2,w=(o+1)/7*Math.PI*2-Math.PI/2,f=(u+w)/2,d=s[o]||0,c=n>0?C+d/n*(S-C):C,m=new THREE.Shape;m.moveTo(0,0);const g=12;for(let v=0;v<=g;v++){const A=u+(w-u)*(v/g);m.lineTo(Math.sin(A)*e,Math.cos(A)*e)}m.lineTo(0,0);const E={depth:c,bevelEnabled:!1},p=new THREE.ExtrudeGeometry(m,E);p.rotateX(-Math.PI/2);const M=new THREE.MeshStandardMaterial({color:a,transparent:!0,opacity:.6,roughness:.2,metalness:.1}),L=new THREE.Mesh(p,M);L.userData.isBasePlatform=!0,this.scene.add(L);const P=e*.6,k=Math.sin(f)*P,B=Math.cos(f)*P,b=document.createElement("canvas");b.width=80,b.height=40;const T=b.getContext("2d");T.fillStyle=this.isDarkMode?"#ffffff":"#1e3a5f",T.font="bold 20px monospace",T.textAlign="center",T.textBaseline="middle",T.fillText(d.toFixed(1)+"mm",40,20);const V=new THREE.CanvasTexture(b),F=new THREE.SpriteMaterial({map:V}),R=new THREE.Sprite(F);R.position.set(k,c+.3,B),R.scale.set(.8,.4,1),R.userData.isBasePlatform=!0,this.scene.add(R)}const t=S+.02,i=this.isDarkMode?5592405:10066329;for(let o=0;o<7;o++){const u=o/7*Math.PI*2-Math.PI/2,w=Math.sin(u)*e,f=Math.cos(u)*e,d=[new THREE.Vector3(0,t,0),new THREE.Vector3(w,t,f)],c=new THREE.BufferGeometry().setFromPoints(d),m=new THREE.LineBasicMaterial({color:i,transparent:!0,opacity:.6}),g=new THREE.Line(c,m);g.userData.isBasePlatform=!0,this.scene.add(g)}const r=new THREE.RingGeometry(3.95,4,64),l=new THREE.MeshBasicMaterial({color:this.isDarkMode?4473924:8947848,transparent:!0,opacity:.5,side:THREE.DoubleSide}),h=new THREE.Mesh(r,l);h.rotation.x=-Math.PI/2,h.position.y=t,h.userData.isBasePlatform=!0,this.scene.add(h)}createDayLabels(){if(this.scene)for(let e=0;e<7;e++){const s=e/7*Math.PI*2-Math.PI/2,n=4.3,a=Math.sin(s)*n,t=Math.cos(s)*n,i=document.createElement("canvas");i.width=100,i.height=50;const r=i.getContext("2d");r.fillStyle=this.isDarkMode?"#aaaaaa":"#555555",r.font="500 24px monospace",r.textAlign="center",r.textBaseline="middle",r.fillText(this.DAYS[e],50,25);const l=new THREE.CanvasTexture(i),h=new THREE.SpriteMaterial({map:l}),o=new THREE.Sprite(h);o.position.set(a,S+.15,t),o.scale.set(1,.5,1),o.userData.isDayLabel=!0,this.scene.add(o)}}createCenterLabel(){if(!this.scene)return;const e=document.createElement("canvas");e.width=256,e.height=128;const s=e.getContext("2d");s.fillStyle=this.isDarkMode?"#4a90d9":"#1a365d",s.font="bold 48px monospace",s.textAlign="center",s.textBaseline="middle",s.fillText(this.city.name.toUpperCase(),128,40);const n=new Date,a=n.getDate(),i=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"][n.getMonth()];s.font="500 32px monospace",s.fillStyle=this.isDarkMode?"#aaaaaa":"#555555",s.fillText(`${a} ${i}`,128,90);const r=new THREE.CanvasTexture(e),l=new THREE.SpriteMaterial({map:r}),h=new THREE.Sprite(l);h.position.set(0,S+1.5,0),h.scale.set(2.5,1.25,1),h.userData.isCenterLabel=!0,this.scene.add(h)}updateSceneColors(){if(!this.scene)return;const e=[];this.scene.children.forEach(s=>{(s.userData.isBasePlatform||s.userData.isDayLabel||s.userData.isCenterLabel)&&e.push(s)}),e.forEach(s=>this.scene.remove(s)),this.createBasePlatform(),this.createDayLabels(),this.createCenterLabel()}drawWindArrow(e,s,n,a,t){const i=(a-90)*Math.PI/180;e.save(),e.translate(s,n),e.rotate(i),e.beginPath(),e.moveTo(0,-t/2),e.lineTo(t/3,t/2),e.lineTo(0,t/3),e.lineTo(-t/3,t/2),e.closePath(),e.fill(),e.restore()}createTemperatureLabel(e,s,n){const a=document.createElement("canvas");if(this.isDetailedMode){a.width=120,a.height=48;const t=a.getContext("2d");t.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",t.beginPath(),t.roundRect(8,8,104,32,4),t.fill(),t.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",t.lineWidth=1,t.stroke(),t.font="500 16px monospace",t.textBaseline="middle";const i=e!==null?`${e}°`:"—";t.fillStyle=y.temperatureMax.css,t.textAlign="right",t.fillText(i,54,24),t.fillStyle=this.isDarkMode?"#666666":"#999999",t.textAlign="center",t.fillText("/",60,24);const r=s!==null?`${s}°`:"—";t.fillStyle=y.temperatureMin.css,t.textAlign="left",t.fillText(r,66,24);const l=new THREE.CanvasTexture(a),h=new THREE.SpriteMaterial({map:l,transparent:!0,depthWrite:!1,depthTest:!1}),o=new THREE.Sprite(h);return o.renderOrder=999,o.position.copy(n),o.position.y+=.5,o.scale.set(1,.4,1),o}else{a.width=96,a.height=48;const t=a.getContext("2d");t.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",t.beginPath(),t.roundRect(8,8,80,32,4),t.fill(),t.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",t.lineWidth=1,t.stroke();const i=e!==null?`${e}°`:"—";t.fillStyle=y.temperature.css,t.font="500 18px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(i,48,24);const r=new THREE.CanvasTexture(a),l=new THREE.SpriteMaterial({map:r,transparent:!0,depthWrite:!1,depthTest:!1}),h=new THREE.Sprite(l);return h.renderOrder=999,h.position.copy(n),h.position.y+=.5,h.scale.set(.8,.4,1),h}}createWindLabel(e,s,n,a){const t=document.createElement("canvas");if(this.isDetailedMode){t.width=160,t.height=48;const i=t.getContext("2d");i.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",i.beginPath(),i.roundRect(4,8,152,32,4),i.fill(),i.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",i.lineWidth=1,i.stroke(),i.fillStyle=y.wind.css,i.font="500 14px monospace",i.textBaseline="middle";const r=e!==null?`${e}kn`:"—";i.textAlign="left",i.fillText(r,14,24),n!==null&&this.drawWindArrow(i,80,24,n,12);const l=s!==null?`G:${s}`:"";i.textAlign="right",i.fillText(l,148,24);const h=new THREE.CanvasTexture(t),o=new THREE.SpriteMaterial({map:h,transparent:!0,depthWrite:!1,depthTest:!1}),u=new THREE.Sprite(o);return u.renderOrder=999,u.position.copy(a),u.position.y+=.5,u.scale.set(1.3,.4,1),u}else{t.width=96,t.height=48;const i=t.getContext("2d");i.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",i.beginPath(),i.roundRect(8,8,80,32,4),i.fill(),i.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",i.lineWidth=1,i.stroke();const r=e!==null?`${e}kn`:"—";i.fillStyle=y.wind.css,i.font="500 18px monospace",i.textAlign="center",i.textBaseline="middle",i.fillText(r,48,24);const l=new THREE.CanvasTexture(t),h=new THREE.SpriteMaterial({map:l,transparent:!0,depthWrite:!1,depthTest:!1}),o=new THREE.Sprite(h);return o.renderOrder=999,o.position.copy(a),o.position.y+=.5,o.scale.set(.8,.4,1),o}}createRing(e,s){if(!this.scene||!this.climateData)return null;const n=y[e],a=z+s*W,t=new THREE.Group,i=[],r=[];if(e==="temperature"){const l=this.climateData.temperature.max,h=this.climateData.temperature.min,o=l.filter(d=>d!==null);if(o.length===0)return null;const u=Math.min(...o),f=Math.max(...o)-u||1;for(let d=0;d<7;d++){const c=d/7*Math.PI*2-Math.PI/2,m=Math.sin(c)*a,g=Math.cos(c)*a;if(l[d]!==null){const E=(l[d]-u)/f,p=D+E*(_-D);r.push({x:m,y:p,z:g,maxTemp:l[d],minTemp:h[d],dayIndex:d})}}r.forEach(d=>{const c=new THREE.SphereGeometry(.16,24,24),m=new THREE.MeshLambertMaterial({color:n.hex,transparent:!0,opacity:.85}),g=new THREE.Mesh(c,m);g.position.set(d.x,d.y,d.z),t.add(g);const E=new THREE.Vector3(d.x,d.y,d.z),p=this.createTemperatureLabel(d.maxTemp??null,d.minTemp??null,E);p.userData.dayIndex=d.dayIndex,p.userData.basePosition=E.clone(),p.visible=!1,i.push(p),t.add(p)})}else if(e==="wind"){const l=this.climateData.wind.speed,h=this.climateData.wind.gusts,o=this.climateData.wind.direction,u=l.filter(c=>c!==null);if(u.length===0)return null;const w=Math.min(...u),d=Math.max(...u)-w||1;for(let c=0;c<7;c++){const m=c/7*Math.PI*2-Math.PI/2,g=Math.sin(m)*a,E=Math.cos(m)*a;if(l[c]!==null){const p=(l[c]-w)/d,M=D+p*(_-D);r.push({x:g,y:M,z:E,speed:l[c],gusts:h[c],direction:o[c],dayIndex:c})}}r.forEach(c=>{const m=new THREE.SphereGeometry(.16,24,24),g=new THREE.MeshLambertMaterial({color:n.hex,transparent:!0,opacity:.85}),E=new THREE.Mesh(m,g);E.position.set(c.x,c.y,c.z),t.add(E);const p=new THREE.Vector3(c.x,c.y,c.z),M=this.createWindLabel(c.speed??null,c.gusts??null,c.direction??null,p);M.userData.dayIndex=c.dayIndex,M.userData.basePosition=p.clone(),M.visible=!1,i.push(M),t.add(M)})}if(r.length>1){const l=r.map(f=>new THREE.Vector3(f.x,f.y,f.z));r.length>=3&&l.push(l[0]);const h=new THREE.CatmullRomCurve3(l),o=new THREE.TubeGeometry(h,72,.06,12,r.length>=3),u=new THREE.MeshLambertMaterial({color:n.hex,transparent:!0,opacity:.75}),w=new THREE.Mesh(o,u);t.add(w)}return t.userData.dataType=e,this.scene.add(t),this.ringLabels[e]=i,t}clearRings(){["temperature","wind"].forEach(e=>{this.ringMeshes[e]&&this.scene&&(this.scene.remove(this.ringMeshes[e]),this.ringMeshes[e]=null),this.ringLabels[e]=[]})}renderAllRings(){this.clearRings(),this.climateData&&(this.ringMeshes.temperature=this.createRing("temperature",0),this.ringMeshes.wind=this.createRing("wind",1),this.updateSceneColors(),this.updateRingFocus())}focusRing(e){this.focusedRing===e?this.focusedRing=null:this.focusedRing=e,this.updateRingFocus(),this.updateLegendStyles()}updateRingFocus(){["temperature","wind"].forEach(e=>{const s=this.ringMeshes[e],n=this.ringLabels[e];if(!s)return;const a=this.focusedRing===e,t=this.focusedRing!==null&&this.focusedRing!==e;s.traverse(i=>{if(i.isMesh&&i.material){const r=i;r.geometry.type==="SphereGeometry"?r.userData.targetOpacity=t?0:.85:r.geometry.type==="TubeGeometry"&&(r.userData.targetOpacity=t?0:.75)}}),n.forEach(i=>{i.userData.shouldShow=a})})}updateLegendStyles(){this.querySelectorAll(".legend-item").forEach(e=>{const s=e,n=s.dataset.type;s.classList.toggle("focused",this.focusedRing===n),s.classList.toggle("dimmed",this.focusedRing!==null&&this.focusedRing!==n)})}setupEventListeners(){this.querySelectorAll(".legend-item").forEach(a=>{a.addEventListener("click",()=>{const t=a.dataset.type;this.focusRing(t)})});const e=this.querySelector("#viewModeToggle");e&&e.addEventListener("click",()=>this.toggleViewMode());const s=this.querySelector("#shareBtn");s&&s.addEventListener("click",()=>this.shareCurrentState());const n=this.querySelector("#retryBtn");n&&n.addEventListener("click",()=>this.loadData())}toggleViewMode(){this.isDetailedMode=!this.isDetailedMode,localStorage.setItem("viewMode",this.isDetailedMode?"detailed":"simple"),this.updateViewModeUI(),this.renderAllRings()}loadViewMode(){const e=localStorage.getItem("viewMode");this.isDetailedMode=e==="detailed",this.updateViewModeUI()}updateViewModeUI(){const e=this.querySelector("#viewModeToggle"),s=this.querySelector("#viewModeText");e&&s&&(e.classList.toggle("detailed",this.isDetailedMode),s.textContent=this.isDetailedMode?"detalhado":"simples")}async shareCurrentState(){const e=window.location.href,s=this.querySelector("#shareBtn"),n=this.querySelector("#shareBtnText");if(!(!s||!n))try{await navigator.clipboard.writeText(e),s.classList.add("copied"),n.textContent="Copiado!",setTimeout(()=>{s.classList.remove("copied"),n.textContent="Partilhar"},2e3)}catch{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),s.classList.add("copied"),n.textContent="Copiado!",setTimeout(()=>{s.classList.remove("copied"),n.textContent="Partilhar"},2e3)}}animateOpacities(){["temperature","wind"].forEach(e=>{const s=this.ringMeshes[e],n=this.ringLabels[e];s&&(s.traverse(a=>{if(a.isMesh){const t=a,i=t.material;if(i&&t.userData.targetOpacity!==void 0){const r=i.opacity,l=t.userData.targetOpacity;Math.abs(r-l)>.01?i.opacity+=(l-r)*I:i.opacity=l}}}),n.forEach(a=>{const t=a.userData.shouldShow,i=a.material.opacity,r=t?1:0;Math.abs(i-r)>.01?(a.material.opacity+=(r-i)*I,a.visible=a.material.opacity>.01):(a.material.opacity=r,a.visible=r>0)}))})}updateLabelVisibility(){if(!this.camera)return;const e=new THREE.Vector3;this.camera.getWorldDirection(e),e.y=0,e.normalize(),["temperature","wind"].forEach(s=>{this.ringLabels[s].forEach(a=>{if(!a.visible)return;const t=a.userData.basePosition.clone();t.y=0,t.normalize();const r=(t.dot(e)+1)/2,l=Math.pow(1-r,1.5),o=a.userData.shouldShow?1:0;a.material.opacity=o*l,a.visible=a.material.opacity>.01})})}animate=()=>{this.animationId=requestAnimationFrame(this.animate),this.orbitControls&&this.orbitControls.update(),this.animateOpacities(),this.updateLabelVisibility(),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)};handleResize(){const e=this.querySelector(".chart-wrapper");if(!e||!this.camera||!this.renderer)return;const s=e.clientWidth,n=e.clientHeight;this.camera.aspect=s/n,this.camera.updateProjectionMatrix(),this.renderer.setSize(s,n)}showLoading(e){const s=this.querySelector(".chart-loading");s&&(s.style.display=e?"flex":"none")}showError(e){const s=this.querySelector(".chart-error");s&&s.classList.toggle("show",e)}async loadData(){this.showLoading(!0),this.showError(!1),this.isLoading=!0;try{this.climateData=await this.fetchClimateData(),this.showLoading(!1),this.isLoading=!1,this.renderAllRings()}catch(e){console.error("Failed to load climate data:",e),this.showLoading(!1),this.showError(!0),this.isLoading=!1,this.updateSceneColors()}}getFromCache(e){try{const s=localStorage.getItem(`${H}${e}`);if(s){const{data:n,timestamp:a}=JSON.parse(s);if(Date.now()-a<360*60*1e3)return n;localStorage.removeItem(`${H}${e}`)}}catch(s){console.warn("Cache read error:",s)}return null}saveToCache(e,s){try{localStorage.setItem(`${H}${e}`,JSON.stringify({data:s,timestamp:Date.now()}))}catch(n){console.warn("Cache write error:",n)}}async fetchWithRetry(e,s=3){let n=null;for(let a=0;a<s;a++)try{const t=await fetch(e);if(t.status===429){const i=Math.pow(2,a)*1e3+Math.random()*1e3;console.log(`Rate limited. Retrying in ${Math.round(i/1e3)}s...`),await new Promise(r=>setTimeout(r,i));continue}if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(t){if(n=t,a<s-1){const i=Math.pow(2,a)*1e3;await new Promise(r=>setTimeout(r,i))}}throw n}async fetchClimateData(){const e=new Date().toISOString().split("T")[0],s=this.getFromCache(e);if(s)return console.log("Using cached forecast data",e),s;const n=`https://api.open-meteo.com/v1/forecast?latitude=${this.city.latitude}&longitude=${this.city.longitude}&daily=temperature_2m_max,temperature_2m_min,wind_gusts_10m_max,wind_speed_10m_max,wind_direction_10m_dominant,precipitation_sum,shortwave_radiation_sum&models=icon_seamless&timezone=GMT&wind_speed_unit=kn`,a=await this.fetchWithRetry(n),t={temperature:{max:a.daily.temperature_2m_max.map(i=>i!==null?Math.round(i):null),min:a.daily.temperature_2m_min.map(i=>i!==null?Math.round(i):null)},wind:{speed:a.daily.wind_speed_10m_max.map(i=>i!==null?Math.round(i):null),gusts:a.daily.wind_gusts_10m_max.map(i=>i!==null?Math.round(i):null),direction:a.daily.wind_direction_10m_dominant.map(i=>i!==null?Math.round(i):null)},precipitation:a.daily.precipitation_sum.map(i=>i!==null?Math.round(i*10)/10:null)};return this.saveToCache(e,t),t}}function O(){typeof THREE<"u"&&THREE.OrbitControls?customElements.get("tempo-chart")||customElements.define("tempo-chart",q):setTimeout(O,50)}O();export{q as TempoChartElement};
