let F=["Dom","Seg","Ter","Qua","Qui","Sex","S\xe1b"],y={temperature:{hex:14427686,css:"#DC2626"},temperatureMax:{hex:15680580,css:"#EF4444"},temperatureMin:{hex:6333946,css:"#60A5FA"},wind:{hex:7041664,css:"#6B7280"}},I=.15,G=3.2,z=.35,D=1,_=5,C=.1,S=1.5,H="porto_climate_";function $(){let e=[],t=new Date;for(let i=0;i<7;i++){let a=new Date(t);a.setDate(t.getDate()+i),0===i?e.push("Hoje"):e.push(F[a.getDay()])}return e}class W extends HTMLElement{city={latitude:41.1496,longitude:-8.611,name:"Porto"};scene=null;camera=null;renderer=null;orbitControls=null;animationId=null;resizeObserver=null;themeObserver=null;ringMeshes={temperature:null,wind:null};ringLabels={temperature:[],wind:[]};climateData=null;focusedRing=null;isDarkMode=!1;isDetailedMode=!1;isLoading=!0;DAYS=$();connectedCallback(){let e=this.dataset.city;if(e)try{this.city=JSON.parse(e)}catch{console.warn("Invalid city config, using default Porto")}this.isDarkMode="dark"===document.documentElement.dataset.theme,this.loadViewMode(),this.waitForThreeJS().then(()=>{this.initScene(),this.setupEventListeners(),this.setupThemeObserver(),this.loadData(),this.animate()})}disconnectedCallback(){this.animationId&&cancelAnimationFrame(this.animationId),this.resizeObserver&&this.resizeObserver.disconnect(),this.themeObserver&&this.themeObserver.disconnect(),this.renderer&&this.renderer.dispose(),this.orbitControls&&this.orbitControls.dispose()}async waitForThreeJS(){return new Promise(e=>{let t=()=>{"u">typeof THREE&&THREE.OrbitControls?e():requestAnimationFrame(t)};t()})}setupThemeObserver(){this.themeObserver=new MutationObserver(e=>{for(let t of e)"data-theme"===t.attributeName&&(this.isDarkMode="dark"===document.documentElement.dataset.theme,this.updateSceneColors(),this.renderAllRings())}),this.themeObserver.observe(document.documentElement,{attributes:!0})}initScene(){let e=this.querySelector(".chart-wrapper");if(!e)return;let t=e.clientWidth,i=e.clientHeight;this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(33,t/i,.1,1e3),this.camera.position.set(9,9,9),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(t,i),this.renderer.setPixelRatio(window.devicePixelRatio),e.appendChild(this.renderer.domElement),this.orbitControls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.orbitControls.target.set(0,2,0),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.05,this.orbitControls.enablePan=!1,this.orbitControls.enableZoom=!1,this.orbitControls.minPolarAngle=Math.PI/2.5,this.orbitControls.maxPolarAngle=Math.PI/2.5,this.orbitControls.update();let a=new THREE.AmbientLight(16777215,.8);this.scene.add(a);let s=new THREE.DirectionalLight(16777215,.4);s.position.set(5,10,5),this.scene.add(s);let r=new THREE.DirectionalLight(16777215,.3);r.position.set(-5,8,-5),this.scene.add(r);let n=new THREE.DirectionalLight(16777215,.2);n.position.set(0,-5,0),this.scene.add(n),this.createBasePlatform(),this.createDayLabels(),this.createCenterLabel(),this.resizeObserver=new ResizeObserver(()=>this.handleResize()),this.resizeObserver.observe(e)}createBasePlatform(){if(!this.scene)return;let e=[0,0,0,0,0,0,0],t=0;if(this.climateData?.precipitation){let i=(e=this.climateData.precipitation.map(e=>e??0)).filter(e=>e>0);t=i.length>0?Math.max(...i):0}for(let i=0;i<7;i++){let a=i/7*Math.PI*2-Math.PI/2,s=(i+1)/7*Math.PI*2-Math.PI/2,r=(a+s)/2,n=e[i]||0,l=t>0?.1+n/t*1.4:.1,o=new THREE.Shape;o.moveTo(0,0);for(let e=0;e<=12;e++){let t=a+(s-a)*(e/12);o.lineTo(4*Math.sin(t),4*Math.cos(t))}o.lineTo(0,0);let h={depth:l,bevelEnabled:!1},d=new THREE.ExtrudeGeometry(o,h);d.rotateX(-Math.PI/2);let c=new THREE.MeshStandardMaterial({color:8246268,transparent:!0,opacity:.6,roughness:.2,metalness:.1}),m=new THREE.Mesh(d,c);m.userData.isBasePlatform=!0,this.scene.add(m);let u=2.4*Math.sin(r),p=2.4*Math.cos(r),g=document.createElement("canvas");g.width=80,g.height=40;let E=g.getContext("2d");E.fillStyle=this.isDarkMode?"#ffffff":"#1e3a5f",E.font="bold 20px monospace",E.textAlign="center",E.textBaseline="middle",E.fillText(n.toFixed(1)+"mm",40,20);let w=new THREE.CanvasTexture(g),f=new THREE.SpriteMaterial({map:w}),M=new THREE.Sprite(f);M.position.set(u,l+.3,p),M.scale.set(.8,.4,1),M.userData.isBasePlatform=!0,this.scene.add(M)}let i=this.isDarkMode?5592405:10066329;for(let e=0;e<7;e++){let t=e/7*Math.PI*2-Math.PI/2,a=4*Math.sin(t),s=4*Math.cos(t),r=[new THREE.Vector3(0,1.52,0),new THREE.Vector3(a,1.52,s)],n=new THREE.BufferGeometry().setFromPoints(r),l=new THREE.LineBasicMaterial({color:i,transparent:!0,opacity:.6}),o=new THREE.Line(n,l);o.userData.isBasePlatform=!0,this.scene.add(o)}let a=new THREE.RingGeometry(3.95,4,64),s=new THREE.MeshBasicMaterial({color:this.isDarkMode?4473924:8947848,transparent:!0,opacity:.5,side:THREE.DoubleSide}),r=new THREE.Mesh(a,s);r.rotation.x=-Math.PI/2,r.position.y=1.52,r.userData.isBasePlatform=!0,this.scene.add(r)}createDayLabels(){if(this.scene)for(let e=0;e<7;e++){let t=e/7*Math.PI*2-Math.PI/2,i=4.3*Math.sin(t),a=4.3*Math.cos(t),s=document.createElement("canvas");s.width=100,s.height=50;let r=s.getContext("2d");r.fillStyle=this.isDarkMode?"#aaaaaa":"#555555",r.font="500 24px monospace",r.textAlign="center",r.textBaseline="middle",r.fillText(this.DAYS[e],50,25);let n=new THREE.CanvasTexture(s),l=new THREE.SpriteMaterial({map:n}),o=new THREE.Sprite(l);o.position.set(i,1.65,a),o.scale.set(1,.5,1),o.userData.isDayLabel=!0,this.scene.add(o)}}createCenterLabel(){if(!this.scene)return;let e=document.createElement("canvas");e.width=256,e.height=128;let t=e.getContext("2d");t.fillStyle=this.isDarkMode?"#4a90d9":"#1a365d",t.font="bold 48px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(this.city.name.toUpperCase(),128,40);let i=new Date,a=i.getDate(),s=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"][i.getMonth()];t.font="500 32px monospace",t.fillStyle=this.isDarkMode?"#aaaaaa":"#555555",t.fillText(`${a} ${s}`,128,90);let r=new THREE.CanvasTexture(e),n=new THREE.SpriteMaterial({map:r}),l=new THREE.Sprite(n);l.position.set(0,3,0),l.scale.set(2.5,1.25,1),l.userData.isCenterLabel=!0,this.scene.add(l)}updateSceneColors(){if(!this.scene)return;let e=[];this.scene.children.forEach(t=>{(t.userData.isBasePlatform||t.userData.isDayLabel||t.userData.isCenterLabel)&&e.push(t)}),e.forEach(e=>this.scene.remove(e)),this.createBasePlatform(),this.createDayLabels(),this.createCenterLabel()}drawWindArrow(e,t,i,a,s){e.save(),e.translate(t,i),e.rotate((a-90)*Math.PI/180),e.beginPath(),e.moveTo(0,-s/2),e.lineTo(s/3,s/2),e.lineTo(0,s/3),e.lineTo(-s/3,s/2),e.closePath(),e.fill(),e.restore()}createTemperatureLabel(e,t,i){let a=document.createElement("canvas");if(this.isDetailedMode){a.width=120,a.height=48;let s=a.getContext("2d");s.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",s.beginPath(),s.roundRect(8,8,104,32,4),s.fill(),s.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",s.lineWidth=1,s.stroke(),s.font="500 16px monospace",s.textBaseline="middle";let r=null!==e?`${e}\xb0`:"—";s.fillStyle=y.temperatureMax.css,s.textAlign="right",s.fillText(r,54,24),s.fillStyle=this.isDarkMode?"#666666":"#999999",s.textAlign="center",s.fillText("/",60,24);let n=null!==t?`${t}\xb0`:"—";s.fillStyle=y.temperatureMin.css,s.textAlign="left",s.fillText(n,66,24);let l=new THREE.CanvasTexture(a),o=new THREE.SpriteMaterial({map:l,transparent:!0,depthWrite:!1,depthTest:!1}),h=new THREE.Sprite(o);return h.renderOrder=999,h.position.copy(i),h.position.y+=.5,h.scale.set(1,.4,1),h}{a.width=96,a.height=48;let t=a.getContext("2d");t.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",t.beginPath(),t.roundRect(8,8,80,32,4),t.fill(),t.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",t.lineWidth=1,t.stroke();let s=null!==e?`${e}\xb0`:"—";t.fillStyle=y.temperature.css,t.font="500 18px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(s,48,24);let r=new THREE.CanvasTexture(a),n=new THREE.SpriteMaterial({map:r,transparent:!0,depthWrite:!1,depthTest:!1}),l=new THREE.Sprite(n);return l.renderOrder=999,l.position.copy(i),l.position.y+=.5,l.scale.set(.8,.4,1),l}}createWindLabel(e,t,i,a){let s=document.createElement("canvas");if(this.isDetailedMode){s.width=160,s.height=48;let r=s.getContext("2d");r.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",r.beginPath(),r.roundRect(4,8,152,32,4),r.fill(),r.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",r.lineWidth=1,r.stroke(),r.fillStyle=y.wind.css,r.font="500 14px monospace",r.textBaseline="middle";let n=null!==e?`${e}kn`:"—";r.textAlign="left",r.fillText(n,14,24),null!==i&&this.drawWindArrow(r,80,24,i,12);let l=null!==t?`G:${t}`:"";r.textAlign="right",r.fillText(l,148,24);let o=new THREE.CanvasTexture(s),h=new THREE.SpriteMaterial({map:o,transparent:!0,depthWrite:!1,depthTest:!1}),d=new THREE.Sprite(h);return d.renderOrder=999,d.position.copy(a),d.position.y+=.5,d.scale.set(1.3,.4,1),d}{s.width=96,s.height=48;let t=s.getContext("2d");t.fillStyle=this.isDarkMode?"rgba(36, 36, 36, 0.95)":"rgba(251, 254, 251, 0.95)",t.beginPath(),t.roundRect(8,8,80,32,4),t.fill(),t.strokeStyle=this.isDarkMode?"rgba(255, 255, 255, 0.08)":"rgba(0, 0, 0, 0.08)",t.lineWidth=1,t.stroke();let i=null!==e?`${e}kn`:"—";t.fillStyle=y.wind.css,t.font="500 18px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(i,48,24);let r=new THREE.CanvasTexture(s),n=new THREE.SpriteMaterial({map:r,transparent:!0,depthWrite:!1,depthTest:!1}),l=new THREE.Sprite(n);return l.renderOrder=999,l.position.copy(a),l.position.y+=.5,l.scale.set(.8,.4,1),l}}createRing(e,t){if(!this.scene||!this.climateData)return null;let i=y[e],a=3.2+.35*t,s=new THREE.Group,r=[],n=[];if("temperature"===e){let e=this.climateData.temperature.max,t=this.climateData.temperature.min,l=e.filter(e=>null!==e);if(0===l.length)return null;let o=Math.min(...l),h=Math.max(...l)-o||1;for(let i=0;i<7;i++){let s=i/7*Math.PI*2-Math.PI/2,r=Math.sin(s)*a,l=Math.cos(s)*a;if(null!==e[i]){let a=1+(e[i]-o)/h*4;n.push({x:r,y:a,z:l,maxTemp:e[i],minTemp:t[i],dayIndex:i})}}n.forEach(e=>{let t=new THREE.SphereGeometry(.16,24,24),a=new THREE.MeshLambertMaterial({color:i.hex,transparent:!0,opacity:.85}),n=new THREE.Mesh(t,a);n.position.set(e.x,e.y,e.z),s.add(n);let l=new THREE.Vector3(e.x,e.y,e.z),o=this.createTemperatureLabel(e.maxTemp??null,e.minTemp??null,l);o.userData.dayIndex=e.dayIndex,o.userData.basePosition=l.clone(),o.visible=!1,r.push(o),s.add(o)})}else if("wind"===e){let e=this.climateData.wind.speed,t=this.climateData.wind.gusts,l=this.climateData.wind.direction,o=e.filter(e=>null!==e);if(0===o.length)return null;let h=Math.min(...o),d=Math.max(...o)-h||1;for(let i=0;i<7;i++){let s=i/7*Math.PI*2-Math.PI/2,r=Math.sin(s)*a,o=Math.cos(s)*a;if(null!==e[i]){let a=1+(e[i]-h)/d*4;n.push({x:r,y:a,z:o,speed:e[i],gusts:t[i],direction:l[i],dayIndex:i})}}n.forEach(e=>{let t=new THREE.SphereGeometry(.16,24,24),a=new THREE.MeshLambertMaterial({color:i.hex,transparent:!0,opacity:.85}),n=new THREE.Mesh(t,a);n.position.set(e.x,e.y,e.z),s.add(n);let l=new THREE.Vector3(e.x,e.y,e.z),o=this.createWindLabel(e.speed??null,e.gusts??null,e.direction??null,l);o.userData.dayIndex=e.dayIndex,o.userData.basePosition=l.clone(),o.visible=!1,r.push(o),s.add(o)})}if(n.length>1){let e=n.map(e=>new THREE.Vector3(e.x,e.y,e.z));n.length>=3&&e.push(e[0]);let t=new THREE.CatmullRomCurve3(e),a=new THREE.TubeGeometry(t,72,.06,12,n.length>=3),r=new THREE.MeshLambertMaterial({color:i.hex,transparent:!0,opacity:.75}),l=new THREE.Mesh(a,r);s.add(l)}return s.userData.dataType=e,this.scene.add(s),this.ringLabels[e]=r,s}clearRings(){["temperature","wind"].forEach(e=>{this.ringMeshes[e]&&this.scene&&(this.scene.remove(this.ringMeshes[e]),this.ringMeshes[e]=null),this.ringLabels[e]=[]})}renderAllRings(){this.clearRings(),this.climateData&&(this.ringMeshes.temperature=this.createRing("temperature",0),this.ringMeshes.wind=this.createRing("wind",1),this.updateSceneColors(),this.updateRingFocus())}focusRing(e){this.focusedRing===e?this.focusedRing=null:this.focusedRing=e,this.updateRingFocus(),this.updateLegendStyles()}updateRingFocus(){["temperature","wind"].forEach(e=>{let t=this.ringMeshes[e],i=this.ringLabels[e];if(!t)return;let a=this.focusedRing===e,s=null!==this.focusedRing&&this.focusedRing!==e;t.traverse(e=>{e.isMesh&&e.material&&("SphereGeometry"===e.geometry.type?e.userData.targetOpacity=s?0:.85:"TubeGeometry"===e.geometry.type&&(e.userData.targetOpacity=s?0:.75))}),i.forEach(e=>{e.userData.shouldShow=a})})}updateLegendStyles(){this.querySelectorAll(".legend-item").forEach(e=>{let t=e.dataset.type;e.classList.toggle("focused",this.focusedRing===t),e.classList.toggle("dimmed",null!==this.focusedRing&&this.focusedRing!==t)})}setupEventListeners(){this.querySelectorAll(".legend-item").forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.type;this.focusRing(t)})});let e=this.querySelector("#viewModeToggle");e&&e.addEventListener("click",()=>this.toggleViewMode());let t=this.querySelector("#shareBtn");t&&t.addEventListener("click",()=>this.shareCurrentState());let i=this.querySelector("#retryBtn");i&&i.addEventListener("click",()=>this.loadData())}toggleViewMode(){this.isDetailedMode=!this.isDetailedMode,localStorage.setItem("viewMode",this.isDetailedMode?"detailed":"simple"),this.updateViewModeUI(),this.renderAllRings()}loadViewMode(){let e=localStorage.getItem("viewMode");this.isDetailedMode="detailed"===e,this.updateViewModeUI()}updateViewModeUI(){let e=this.querySelector("#viewModeToggle"),t=this.querySelector("#viewModeText");e&&t&&(e.classList.toggle("detailed",this.isDetailedMode),t.textContent=this.isDetailedMode?"detalhado":"simples")}async shareCurrentState(){let e=window.location.href,t=this.querySelector("#shareBtn"),i=this.querySelector("#shareBtnText");if(!(!t||!i))try{await navigator.clipboard.writeText(e),t.classList.add("copied"),i.textContent="Copiado!",setTimeout(()=>{t.classList.remove("copied"),i.textContent="Partilhar"},2e3)}catch{let a=document.createElement("textarea");a.value=e,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),t.classList.add("copied"),i.textContent="Copiado!",setTimeout(()=>{t.classList.remove("copied"),i.textContent="Partilhar"},2e3)}}animateOpacities(){["temperature","wind"].forEach(e=>{let t=this.ringMeshes[e],i=this.ringLabels[e];t&&(t.traverse(e=>{if(e.isMesh){let t=e.material;if(t&&void 0!==e.userData.targetOpacity){let i=t.opacity,a=e.userData.targetOpacity;Math.abs(i-a)>.01?t.opacity+=(a-i)*.15:t.opacity=a}}}),i.forEach(e=>{let t=e.userData.shouldShow,i=e.material.opacity,a=t?1:0;Math.abs(i-a)>.01?(e.material.opacity+=(a-i)*.15,e.visible=e.material.opacity>.01):(e.material.opacity=a,e.visible=a>0)}))})}updateLabelVisibility(){if(!this.camera)return;let e=new THREE.Vector3;this.camera.getWorldDirection(e),e.y=0,e.normalize(),["temperature","wind"].forEach(t=>{this.ringLabels[t].forEach(t=>{if(!t.visible)return;let i=t.userData.basePosition.clone();i.y=0,i.normalize();let a=(i.dot(e)+1)/2,s=t.userData.shouldShow?1:0;t.material.opacity=s*Math.pow(1-a,1.5),t.visible=t.material.opacity>.01})})}animate=()=>{this.animationId=requestAnimationFrame(this.animate),this.orbitControls&&this.orbitControls.update(),this.animateOpacities(),this.updateLabelVisibility(),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)};handleResize(){let e=this.querySelector(".chart-wrapper");if(!e||!this.camera||!this.renderer)return;let t=e.clientWidth,i=e.clientHeight;this.camera.aspect=t/i,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,i)}showLoading(e){let t=this.querySelector(".chart-loading");t&&(t.style.display=e?"flex":"none")}showError(e){let t=this.querySelector(".chart-error");t&&t.classList.toggle("show",e)}async loadData(){this.showLoading(!0),this.showError(!1),this.isLoading=!0;try{this.climateData=await this.fetchClimateData(),this.showLoading(!1),this.isLoading=!1,this.renderAllRings()}catch(e){console.error("Failed to load climate data:",e),this.showLoading(!1),this.showError(!0),this.isLoading=!1,this.updateSceneColors()}}getFromCache(e){try{let t=localStorage.getItem(`${H}${e}`);if(t){let{data:i,timestamp:a}=JSON.parse(t);if(Date.now()-a<216e5)return i;localStorage.removeItem(`${H}${e}`)}}catch(e){console.warn("Cache read error:",e)}return null}saveToCache(e,t){try{localStorage.setItem(`${H}${e}`,JSON.stringify({data:t,timestamp:Date.now()}))}catch(e){console.warn("Cache write error:",e)}}async fetchWithRetry(e,t=3){let i=null;for(let a=0;a<t;a++)try{let t=await fetch(e);if(429===t.status){let e=1e3*Math.pow(2,a)+1e3*Math.random();console.log(`Rate limited. Retrying in ${Math.round(e/1e3)}s...`),await new Promise(t=>setTimeout(t,e));continue}if(!t.ok)throw Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(e){if(i=e,a<t-1){let e=1e3*Math.pow(2,a);await new Promise(t=>setTimeout(t,e))}}throw i}async fetchClimateData(){let e=new Date().toISOString().split("T")[0],t=this.getFromCache(e);if(t)return console.log("Using cached forecast data",e),t;let i=`https://api.open-meteo.com/v1/forecast?latitude=${this.city.latitude}&longitude=${this.city.longitude}&daily=temperature_2m_max,temperature_2m_min,wind_gusts_10m_max,wind_speed_10m_max,wind_direction_10m_dominant,precipitation_sum,shortwave_radiation_sum&models=icon_seamless&timezone=GMT&wind_speed_unit=kn`,a=await this.fetchWithRetry(i),s={temperature:{max:a.daily.temperature_2m_max.map(e=>null!==e?Math.round(e):null),min:a.daily.temperature_2m_min.map(e=>null!==e?Math.round(e):null)},wind:{speed:a.daily.wind_speed_10m_max.map(e=>null!==e?Math.round(e):null),gusts:a.daily.wind_gusts_10m_max.map(e=>null!==e?Math.round(e):null),direction:a.daily.wind_direction_10m_dominant.map(e=>null!==e?Math.round(e):null)},precipitation:a.daily.precipitation_sum.map(e=>null!==e?Math.round(10*e)/10:null)};return this.saveToCache(e,s),s}}customElements.get("tempo-chart")||customElements.define("tempo-chart",W);