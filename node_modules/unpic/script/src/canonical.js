"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCanonicalCdnForUrl = exports.getDelegatedCdn = void 0;
const detect_js_1 = require("./detect.js");
const vercel_js_1 = require("./transformers/vercel.js");
const nextjs_js_1 = require("./transformers/nextjs.js");
// Image servers that might delegate to another CDN
const delegators = {
    vercel: vercel_js_1.delegateUrl,
    nextjs: nextjs_js_1.delegateUrl,
};
function getDelegatedCdn(url, cdn) {
    // Most CDNs are authoritative for their own URLs
    if (!(cdn in delegators)) {
        return false;
    }
    const maybeDelegate = delegators[cdn];
    if (!maybeDelegate) {
        return false;
    }
    return maybeDelegate(url);
}
exports.getDelegatedCdn = getDelegatedCdn;
/**
 * Gets the canonical URL and CDN for a given image URL, recursing into
 * the source image if it is hosted on another CDN.
 */
function getCanonicalCdnForUrl(url, defaultCdn) {
    const cdn = (0, detect_js_1.getImageCdnForUrl)(url) || defaultCdn;
    if (!cdn) {
        return false;
    }
    const maybeDelegated = getDelegatedCdn(url, cdn);
    if (maybeDelegated) {
        return maybeDelegated;
    }
    return { cdn, url };
}
exports.getCanonicalCdnForUrl = getCanonicalCdnForUrl;
