"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parse = exports.transform = void 0;
const utils_js_1 = require("../utils.js");
const getTransformParams = (url) => {
    const transforms = url.searchParams.get('tr') || "";
    return transforms.split(',').reduce((acc, transform) => {
        const [key, value] = transform.split('-');
        acc[key] = value;
        return acc;
    }, {});
};
const transform = ({ url: originalUrl, width, height, format }) => {
    const url = (0, utils_js_1.toUrl)(originalUrl);
    const transformParams = getTransformParams(url);
    transformParams.w = width ? Math.round(width) : width;
    transformParams.h = height ? Math.round(height) : height;
    if (!transformParams.fm) {
        transformParams.fm = 'auto';
    }
    if (format) {
        transformParams.fm = format;
    }
    const tr = Object.keys(transformParams).map(key => {
        const value = transformParams[key];
        if (value) {
            return `${key}-${value}`;
        }
    })
        .filter(x => x)
        .join(',');
    url.searchParams.set('tr', tr);
    return url;
};
exports.transform = transform;
const parse = (url) => {
    const parsed = (0, utils_js_1.toUrl)(url);
    const transformParams = getTransformParams(parsed);
    const width = Number(transformParams.w) || undefined;
    const height = Number(transformParams.h) || undefined;
    const format = transformParams.fm || undefined;
    parsed.search = "";
    return {
        base: parsed.toString(),
        width,
        height,
        format,
        params: transformParams,
        cdn: "imagekit",
    };
};
exports.parse = parse;
